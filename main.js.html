<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: main.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: main.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*eslint no-console: [2, { allow: ["warn", "error","info","log","debug"] }] */

'use strict'

const electron = require( 'electron' ),
  app = electron.app,
  Menu = require( 'electron' ).Menu,
  dialog = require( 'electron' ).dialog,
  ipc = require( 'electron' ).ipcMain,
  path = require( 'path' ),
  pjson = require( './package.json' ),
  _ = require( 'lodash' ),
  windowStateKeeper = require( 'electron-window-state' );

var config = {}

// Use system log facility, should work on Windows too
require( './lib/log' )( pjson.productName || 'CMIDataCollector' )

// Manage unhandled exceptions as early as possible
process.on( 'uncaughtException', ( e ) => {
  console.error( `Caught unhandled exception: ${e}` )
  dialog.showErrorBox( 'Caught unhandled exception', e.message || 'Unknown error message' )
  app.quit()
} )

// Load build target configuration file
try {
  config = require( './config.json' )
  _.merge( pjson.config, config )
} catch ( e ) {
  console.warn( 'No config file loaded, using defaults' )
}

let isDev = ( require( 'electron-is-dev' ) || pjson.config.debug ),
  // Prevent window being garbage collected
  mainWindow,
  // Other windows we may need
  infoWindow = null,
  // usado para cuando se abre la app con deep-linking
  urlData;

global.appSettings = pjson.config

if ( isDev ) {
  console.info( 'Running in development' )
} else {
  console.info( 'Running in production' )
}

console.debug( JSON.stringify( pjson.config ) )

// Adds debug features like hotkeys for triggering dev tools and reload
// (disabled in production, unless the menu item is displayed)
require( 'electron-debug' )( {
  // enabled: pjson.config.debug || isDev || false
  enabled: true
} )


app.setName( pjson.productName || 'SkelEktron' )

/**
 * @name initialize
 * @returns {void}
 */
function initialize() {
  var shouldQuit = makeSingleInstance()
  if ( shouldQuit ) {
    return app.quit()
  }

  /**
   * @name onClosed
   * @description
   * Dereference used windows
   * for multiple windows store them in an array
   * @returns { Void } void
   */
  function onClosed() {
    mainWindow = null
    infoWindow = null
  }

  /**
   * @description
   * Scaffolds the main window
   * @returns { Boolean } exit code
   */
  function createMainWindow() {
    // Load the previous window state with fallback to defaults
    let mainWindowState = windowStateKeeper( {
      defaultWidth: 1024,
      defaultHeight: 768
    } )

    const win = new electron.BrowserWindow( {
      'width': mainWindowState.width,
      'height': mainWindowState.height,
      'x': mainWindowState.x,
      'y': mainWindowState.y,
      'title': app.getName(),
      'icon': path.join( __dirname, '/app/assets/img/icon.png' ),
      // Hide your application until your page has loaded
      'show': false,
      'webPreferences': {
        // Disabling node integration allows to use libraries such as jQuery/React, etc
        'nodeIntegration': pjson.config.nodeIntegration || true,
        'preload': path.resolve( path.join( __dirname, '/backend/preload.js' ) )
      }
    } )

    // Let us register listeners on the window, so we can update the state
    // automatically (the listeners will be removed when the window is closed)
    // and restore the maximized or full screen state
    mainWindowState.manage( win )

    // Remove file:// if you need to load http URLs
    win.loadURL( `file://${__dirname}/${pjson.config.url}`, {} )

    win.on( 'closed', onClosed )

    // Then, when everything is loaded, show the window and focus it so it pops up for the user
    // Yon can also use: win.webContents.on('did-finish-load')
    win.on( 'ready-to-show', () => {
      win.show()
      win.focus()
    } )

    win.on( 'unresponsive', function onUnresponsive() {
      // In the real world you should display a box and do something
      console.warn( 'The windows is not responding' )
    } )

    win.webContents.on( 'did-fail-load', ( error, errorCode, errorDescription ) => {
      var errorMessage

      if ( errorCode === -105 ) {
        errorMessage = errorDescription || '[Connection Error] The host name could not be resolved, check your network connection'
        console.log( errorMessage )
      } else {
        errorMessage = errorDescription || 'Unknown error'
      }

      error.sender.loadURL( `file://${__dirname}/error.html` )
      win.webContents.on( 'did-finish-load', () => {
        win.webContents.send( 'app-error', errorMessage )
      } )
    } )

    win.webContents.on( 'crashed', () => {
      // In the real world you should display a box and do something
      console.error( 'The browser window has just crashed' )
    } )

    win.webContents.on( 'did-finish-load', () => {
      win.webContents.send( 'hello' )
    } )

    return win
  }

  app.on( 'window-all-closed', () => {
    if ( process.platform !== 'darwin' ) {
      app.quit()
    }
  } )

  app.on( 'activate', () => {
    if ( !mainWindow ) {
      mainWindow = createMainWindow()
    }
  } )

  app.setAsDefaultProtocolClient( 'data-collector' );

  app.on( 'ready', () => {
    Menu.setApplicationMenu( createMenu() )
    mainWindow = createMainWindow()

    // enviar todos los datos que no fueron posibles anteriormente xq no se habia creado mainWindow;
    handleUrl( {}, urlData );

    // Manage automatic updates
    try {
      require( './lib/auto-update/update' )( {
        url: ( pjson.config.update ) ? pjson.config.update.url || false : false,
        version: app.getVersion()
      } )
      ipc.on( 'update-downloaded', ( autoUpdater ) => {
        // Elegant solution: display unobtrusive notification messages
        mainWindow.webContents.send( 'update-downloaded' )
        ipc.on( 'update-and-restart', () => {
          autoUpdater.quitAndInstall()
        } )

        // Basic solution: display a message box to the user
        // var updateNow = dialog.showMessageBox(mainWindow, {
        //   type: 'question',
        //   buttons: ['Yes', 'No'],
        //   defaultId: 0,
        //   cancelId: 1,
        //   title: 'Update available',
        //   message: 'There is an update available, do you want to restart and install it now?'
        // })
        //
        // if (updateNow === 0) {
        //   autoUpdater.quitAndInstall()
        // }
      } )
    } catch ( e ) {
      console.error( e.message )
      dialog.showErrorBox( 'Update Error', e.message )
    }

  } )

  app.on( 'will-quit', () => {} )

  app.on( 'open-url', handleUrl );

  ipc.on( 'open-info-window', () => {
    if ( infoWindow ) {
      return
    }
    infoWindow = new electron.BrowserWindow( {
      width: 600,
      height: 600,
      resizable: false
    } )
    infoWindow.loadURL( `file://${__dirname}/info.html` )

    infoWindow.on( 'closed', () => {
      infoWindow = null
    } )
  } )

  // Listen for sync message from renderer process
  ipc.on( 'electron-msg', ( event, arg ) => {
    mainWindow.webContents.send( arg.msg, arg.data );
  } );

  ipc.on( 'renderer-msg', ( event, arg ) => {
    mainWindow.webContents.send( 'electron-msg', arg );
  } );
}


  /**
   * @name handleUrl
   * @description Envia al proceso principal la ruta elegida en deeplinking para abrir la aplicacion
   * @param {any} event - Evento
   * @param {any} params - Url a enviar al proceso renderer
   * @returns {void}
   */
function handleUrl( event, params ) {

  if ( !mainWindow || !mainWindow.webContents ) {
    urlData = params;
    return;
  }

  mainWindow.webContents.send( 'init-params', params );
}

/**
 * @name makeSingleInstance
 * @description
 * Make this app a single instance app.
 *
 * The main window will be restored and focused instead of a second window
 * opened when a person attempts to launch a second instance.
 *
 * Returns true if the current version of the app should quit instead of
 * launching.
 * @returns  { Object } singleton instance
 */
function makeSingleInstance() {
  return app.makeSingleInstance( ( commandLine, workingDirectory ) => {
    handleUrl( {}, workingDirectory[ 1 ] );
    if ( mainWindow ) {
      if ( mainWindow.isMinimized() ) {
        mainWindow.restore()
      }
      mainWindow.focus()
    }
  } )
}

/**
 * @name createMenu
 *
 * @returns { Object } Menu
 */
function createMenu() {
  return Menu.buildFromTemplate( require( './lib/menu' ) )
}

// Manage Squirrel startup event (Windows)
require( './lib/auto-update/startup' )( initialize )
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Externals</h3><ul><li><a href="external-Duplex.html">Duplex</a></li><li><a href="external-Readable.html">Readable</a></li></ul><h3>Classes</h3><ul><li><a href="Admin.html">Admin</a></li><li><a href="AggregationCursor.html">AggregationCursor</a></li><li><a href="BulkWriteResult.html">BulkWriteResult</a></li><li><a href="Chunk.html">Chunk</a></li><li><a href="Collection.html">Collection</a></li><li><a href="CommandCursor.html">CommandCursor</a></li><li><a href="Cursor.html">Cursor</a></li><li><a href="Db.html">Db</a></li><li><a href="FindOperatorsOrdered.html">FindOperatorsOrdered</a></li><li><a href="FindOperatorsUnordered.html">FindOperatorsUnordered</a></li><li><a href="GridFSBucket.html">GridFSBucket</a></li><li><a href="GridFSBucketReadStream.html">GridFSBucketReadStream</a></li><li><a href="GridFSBucketWriteStream.html">GridFSBucketWriteStream</a></li><li><a href="GridStore.html">GridStore</a></li><li><a href="GridStoreStream.html">GridStoreStream</a></li><li><a href="MongoClient.html">MongoClient</a></li><li><a href="Mongos.html">Mongos</a></li><li><a href="OrderedBulkOperation.html">OrderedBulkOperation</a></li><li><a href="ReadPreference.html">ReadPreference</a></li><li><a href="ReplSet.html">ReplSet</a></li><li><a href="Server.html">Server</a></li><li><a href="UnorderedBulkOperation.html">UnorderedBulkOperation</a></li><li><a href="WriteConcernError.html">WriteConcernError</a></li><li><a href="WriteError.html">WriteError</a></li></ul><h3>Events</h3><ul><li><a href="AggregationCursor.html#event:close">close</a></li><li><a href="AggregationCursor.html#event:data">data</a></li><li><a href="AggregationCursor.html#event:end">end</a></li><li><a href="AggregationCursor.html#event:readable">readable</a></li><li><a href="CommandCursor.html#event:close">close</a></li><li><a href="CommandCursor.html#event:data">data</a></li><li><a href="CommandCursor.html#event:end">end</a></li><li><a href="CommandCursor.html#event:readable">readable</a></li><li><a href="Cursor.html#event:close">close</a></li><li><a href="Cursor.html#event:data">data</a></li><li><a href="Cursor.html#event:end">end</a></li><li><a href="Cursor.html#event:readable">readable</a></li><li><a href="Db.html#event:authenticated">authenticated</a></li><li><a href="Db.html#event:close">close</a></li><li><a href="Db.html#event:error">error</a></li><li><a href="Db.html#event:fullsetup">fullsetup</a></li><li><a href="Db.html#event:parseError">parseError</a></li><li><a href="Db.html#event:reconnect">reconnect</a></li><li><a href="Db.html#event:timeout">timeout</a></li><li><a href="GridFSBucket.html#event:index">index</a></li><li><a href="GridFSBucketReadStream.html#event:close">close</a></li><li><a href="GridFSBucketReadStream.html#event:data">data</a></li><li><a href="GridFSBucketReadStream.html#event:end">end</a></li><li><a href="GridFSBucketReadStream.html#event:error">error</a></li><li><a href="GridFSBucketReadStream.html#event:file">file</a></li><li><a href="GridFSBucketWriteStream.html#event:error">error</a></li><li><a href="GridFSBucketWriteStream.html#event:finish">finish</a></li><li><a href="GridStoreStream.html#event:close">close</a></li><li><a href="GridStoreStream.html#event:data">data</a></li><li><a href="GridStoreStream.html#event:drain">drain</a></li><li><a href="GridStoreStream.html#event:end">end</a></li><li><a href="GridStoreStream.html#event:error">error</a></li><li><a href="GridStoreStream.html#event:finish">finish</a></li><li><a href="GridStoreStream.html#event:pipe">pipe</a></li><li><a href="GridStoreStream.html#event:readable">readable</a></li><li><a href="GridStoreStream.html#event:unpipe">unpipe</a></li><li><a href="Mongos.html#event:close">close</a></li><li><a href="Mongos.html#event:connect">connect</a></li><li><a href="Mongos.html#event:error">error</a></li><li><a href="Mongos.html#event:fullsetup">fullsetup</a></li><li><a href="Mongos.html#event:ha">ha</a></li><li><a href="Mongos.html#event:joined">joined</a></li><li><a href="Mongos.html#event:left">left</a></li><li><a href="Mongos.html#event:open">open</a></li><li><a href="Mongos.html#event:parseError">parseError</a></li><li><a href="Mongos.html#event:timeout">timeout</a></li><li><a href="ReplSet.html#event:close">close</a></li><li><a href="ReplSet.html#event:connect">connect</a></li><li><a href="ReplSet.html#event:error">error</a></li><li><a href="ReplSet.html#event:fullsetup">fullsetup</a></li><li><a href="ReplSet.html#event:ha">ha</a></li><li><a href="ReplSet.html#event:joined">joined</a></li><li><a href="ReplSet.html#event:left">left</a></li><li><a href="ReplSet.html#event:open">open</a></li><li><a href="ReplSet.html#event:parseError">parseError</a></li><li><a href="ReplSet.html#event:timeout">timeout</a></li><li><a href="Server.html#event:close">close</a></li><li><a href="Server.html#event:connect">connect</a></li><li><a href="Server.html#event:error">error</a></li><li><a href="Server.html#event:parseError">parseError</a></li><li><a href="Server.html#event:reconnect">reconnect</a></li><li><a href="Server.html#event:timeout">timeout</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addDatabaseController">addDatabaseController</a></li><li><a href="global.html#apiClient">apiClient</a></li><li><a href="global.html#authenticate">authenticate</a></li><li><a href="global.html#cancel">cancel</a></li><li><a href="global.html#configureIndicatorController">configureIndicatorController</a></li><li><a href="global.html#convertReadPreference">convertReadPreference</a></li><li><a href="global.html#createMenu">createMenu</a></li><li><a href="global.html#csvAdapter">csvAdapter</a></li><li><a href="global.html#datasourceTableController">datasourceTableController</a></li><li><a href="global.html#disableZoomUI">disableZoomUI</a></li><li><a href="global.html#enableZoomUI">enableZoomUI</a></li><li><a href="global.html#excelAdapter">excelAdapter</a></li><li><a href="global.html#executeMonthQuery">executeMonthQuery</a></li><li><a href="global.html#GET">GET</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDataSourceProvider">getDataSourceProvider</a></li><li><a href="global.html#getDatasources">getDatasources</a></li><li><a href="global.html#getFromToDates">getFromToDates</a></li><li><a href="global.html#getImportPreview">getImportPreview</a></li><li><a href="global.html#getImportQuery">getImportQuery</a></li><li><a href="global.html#getIndicator">getIndicator</a></li><li><a href="global.html#getIndicatorsSync">getIndicatorsSync</a></li><li><a href="global.html#getLastMonthData">getLastMonthData</a></li><li><a href="global.html#getMaxDate">getMaxDate</a></li><li><a href="global.html#getMonthlyData">getMonthlyData</a></li><li><a href="global.html#getServerInfo">getServerInfo</a></li><li><a href="global.html#getTableData">getTableData</a></li><li><a href="global.html#getTables">getTables</a></li><li><a href="global.html#getZoomUI">getZoomUI</a></li><li><a href="global.html#goToNext">goToNext</a></li><li><a href="global.html#handleDatabaseOk">handleDatabaseOk</a></li><li><a href="global.html#handleDatasourceOk">handleDatasourceOk</a></li><li><a href="global.html#handleUrl">handleUrl</a></li><li><a href="global.html#homeController">homeController</a></li><li><a href="global.html#importData">importData</a></li><li><a href="global.html#importPreviewController">importPreviewController</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#jsonAdapter">jsonAdapter</a></li><li><a href="global.html#listDatasources">listDatasources</a></li><li><a href="global.html#loadIndicator">loadIndicator</a></li><li><a href="global.html#loadTableData">loadTableData</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginController">loginController</a></li><li><a href="global.html#mainController">mainController</a></li><li><a href="global.html#makeSingleInstance">makeSingleInstance</a></li><li><a href="global.html#mongoAdapter">mongoAdapter</a></li><li><a href="global.html#mssqlAdapter">mssqlAdapter</a></li><li><a href="global.html#mySqlAdapter">mySqlAdapter</a></li><li><a href="global.html#ok">ok</a></li><li><a href="global.html#onClosed">onClosed</a></li><li><a href="global.html#onConnectionError">onConnectionError</a></li><li><a href="global.html#onDateSelected">onDateSelected</a></li><li><a href="global.html#onValueSelected">onValueSelected</a></li><li><a href="global.html#openDatasourceFile">openDatasourceFile</a></li><li><a href="global.html#openMenu">openMenu</a></li><li><a href="global.html#POST">POST</a></li><li><a href="global.html#processDataSource">processDataSource</a></li><li><a href="global.html#queryImportCallback">queryImportCallback</a></li><li><a href="global.html#resumeMessages">resumeMessages</a></li><li><a href="global.html#safeApply">safeApply</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#saveDatabase">saveDatabase</a></li><li><a href="global.html#saveDataSource">saveDataSource</a></li><li><a href="global.html#saveIndicator">saveIndicator</a></li><li><a href="global.html#saveIndicatorData">saveIndicatorData</a></li><li><a href="global.html#selectTable">selectTable</a></li><li><a href="global.html#sendMessageToMain">sendMessageToMain</a></li><li><a href="global.html#setConnection">setConnection</a></li><li><a href="global.html#setConnString">setConnString</a></li><li><a href="global.html#setDataSource">setDataSource</a></li><li><a href="global.html#setListeners">setListeners</a></li><li><a href="global.html#setupConnection">setupConnection</a></li><li><a href="global.html#showDatabaseDialog">showDatabaseDialog</a></li><li><a href="global.html#showFileDialog">showFileDialog</a></li><li><a href="global.html#showLoginDialog">showLoginDialog</a></li><li><a href="global.html#sync">sync</a></li><li><a href="global.html#utils">utils</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Mar 08 2017 05:21:56 GMT+0000 (UTC)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
